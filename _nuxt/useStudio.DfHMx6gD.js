import{u as z,a as E,b as B,c as $,r as H,d as G,e as O,f as D,g as Q,t as K,h as V}from"./entry.AZD4bpIE.js";import{q as X,u as Y}from"./query.OqExn6yp.js";import Z from"./ContentPreviewMode.s9QNKlt9.js";import"./preview.DEY42aUL.js";const j=(s=[],d,a)=>{const c=[...d||[]],v=[...a||[]],f=JSON.parse(JSON.stringify(s));for(const o of c)if(o.oldPath)if(v.splice(v.findIndex(l=>l.path===o.oldPath),1),c.find(l=>l.path===o.oldPath))f.push({path:o.path,parsed:o.parsed});else{const l=f.find(h=>h.path===o.oldPath);l&&(l.path=o.path,o.parsed?l.parsed=o.parsed:o.pathMeta&&["_file","_path","_id","_locale"].forEach(h=>{l.parsed[h]=o.pathMeta[h]}))}else if(o.new)f.push({path:o.path,parsed:o.parsed});else{const w=f.find(l=>l.path===o.path);w&&Object.assign(w,{path:o.path,parsed:o.parsed})}for(const o of v)f.splice(f.findIndex(w=>w.path===o.path),1);const I=new Intl.Collator(void 0,{numeric:!0});return f.sort((o,w)=>I.compare(o.path,w.path)),f},y={appConfig:"app.config.ts",nuxtConfig:"nuxt.config.ts",tokensConfig:"tokens.config.ts"},ee=s=>{let d;return a=>(d||(d=s()),d)};function F(s,d){for(const a in s){const c=d[a];a in d||delete s[a],c!==null&&typeof c=="object"&&F(s[a],d[a])}}function L(s,d){for(const a in d){const c=d[a];c!==null&&typeof c=="object"?Array.isArray(c)&&Array.isArray(s[a])?s[a]=c:(s[a]=s[a]||{},L(s[a],c)):s[a]=c}}const te=ee(()=>JSON.parse(JSON.stringify(D()))),M=V((s,d,a)=>{if(Array.isArray(s[d])&&Array.isArray(a))return s[d]=a,!0}),de=()=>{const s=G(),{studio:d,content:a}=z().public,c={},v=window.sessionStorage.getItem("previewAPI")||(d==null?void 0:d.apiURL),f=te();let I;const o=E("studio-client-db",()=>null),w=E("studio-preview-db-files",()=>[]);o.value||(s.hook("content:storage",t=>{o.value=t}),X("/non-existing-path").findOne());const l=async(t,n)=>{const i=window.sessionStorage.getItem("previewToken"),r=await t.getKeys(`${i}:`);await Promise.all(r.map(e=>t.removeItem(e)));const p=new Set(n.map(e=>e.parsed._id.split(":").shift()));await t.setItem(`${i}$`,JSON.stringify({ignoreSources:Array.from(p)})),await Promise.all(n.map(e=>(c[e.parsed._path]=e.parsed,t.setItem(`${i}:${e.parsed._id}`,JSON.stringify(e.parsed)))))},h=t=>{const n=O(s,D);n!=null&&n.ui&&(n.ui.icons={...n.ui.icons,dynamic:!0}),L(n,M(t,f)),t||F(n,f)},_=t=>{var i,r,p,e;const n=(e=(p=(r=(i=s==null?void 0:s.vueApp)==null?void 0:i._context)==null?void 0:r.config)==null?void 0:p.globalProperties)==null?void 0:e.$pinceauTheme;!n||!(n!=null&&n.updateTheme)||(I||(I=JSON.parse(JSON.stringify((n==null?void 0:n.theme.value)||{}))),O(s,n.updateTheme,[M(t,I)]))},R=async t=>{if(w.value=t.files=t.files||w.value||[],!o.value)return!1;const n=j(t.files,t.additions,t.deletions),i=n.filter(e=>![y.appConfig,y.nuxtConfig,y.tokensConfig].includes(e.path));await l(o.value,i);const r=n.find(e=>e.path===y.appConfig);h(r==null?void 0:r.parsed);const p=n.find(e=>e.path===y.tokensConfig);return _(p==null?void 0:p.parsed),P(),!0},N=async()=>{const t=window.sessionStorage.getItem("previewToken");await $fetch("api/projects/preview/sync",{baseURL:v,method:"POST",params:{token:t}})},U=()=>{const t=window.sessionStorage.getItem("previewToken"),n=document.createElement("div");n.id="__nuxt_preview_wrapper",document.body.appendChild(n),Q(Z,{previewToken:t,apiURL:v,syncPreview:R,requestPreviewSyncAPI:N}).mount(n)},C=async t=>{var r,p,e;const n=window.sessionStorage.getItem("previewToken");if(!t)return null;t=t.replace(/\/$/,"");let i=await((r=o.value)==null?void 0:r.getItem(`${n}:${t}`));return i||(i=await((p=o.value)==null?void 0:p.getItem(`cached:${t}`))),i||(i=i=await((e=o.value)==null?void 0:e.getItem(t))),i||(i=c[t||"/"]),i},b=t=>{var i;const n=window.sessionStorage.getItem("previewToken");o.value&&(c[t.parsed._path]=t.parsed,o.value.setItem(`${n}:${(i=t.parsed)==null?void 0:i._id}`,JSON.stringify(t.parsed)))},J=async t=>{var r;const n=window.sessionStorage.getItem("previewToken"),i=await C(t);if(await((r=o.value)==null?void 0:r.removeItem(`${n}:${t}`)),i){delete c[i._path];const p=await C(i._id);p&&(c[p._path]=p)}},P=async()=>{if(a!=null&&a.documentDriven){const{pages:t}=O(s,Y),n=await Promise.all(Object.keys(t.value).map(async i=>{var r;return await C(((r=t.value[i])==null?void 0:r._id)??i)}));t.value=n.reduce((i,r,p)=>(r&&(i[Object.keys(t.value)[p]]=r),i),{})}await s.hooks.callHookParallel("app:data:refresh")};return{apiURL:v,contentStorage:o,syncPreviewFiles:l,syncPreviewAppConfig:h,syncPreviewTokensConfig:_,requestPreviewSynchronization:N,findContentWithId:C,updateContent:b,removeContentWithId:J,requestRerender:P,mountPreviewUI:U,initiateIframeCommunication:W};function W(){if(!window.parent||window.self===window.parent)return;const t=B(),n=$(),i=H(""),r=e=>({path:e.path,query:K(e.query),params:K(e.params),fullPath:e.fullPath,meta:K(e.meta)});window.addEventListener("keydown",e=>{(e.metaKey||e.ctrlKey||e.altKey||e.shiftKey)&&window.parent.postMessage({type:"nuxt-studio:preview:keydown",payload:{key:e.key,metaKey:e.metaKey,ctrlKey:e.ctrlKey,shiftKey:e.shiftKey,altKey:e.altKey}},"*")}),window.addEventListener("message",async e=>{var q;if(!["https://nuxt.studio","https://new.nuxt.studio","https://new.dev.nuxt.studio","https://dev.nuxt.studio","http://localhost:3000",...((q=d==null?void 0:d.iframeMessagingAllowedOrigins)==null?void 0:q.split(",").map(u=>u.trim()))||[]].includes(e.origin))return;const{type:T,payload:A={}}=e.data||{};switch(T){case"nuxt-studio:editor:file-selected":{const u=await C(A.path);u&&(u._partial||u._path!==$().path&&(i.value=u._path,t.push(u._path)));break}case"nuxt-studio:editor:file-changed":{const{additions:u=[],deletions:S=[]}=A;for(const g of u)await b(g);for(const g of S)await J(g.path);P();break}case"nuxt-studio:preview:sync":{R(A);break}case"nuxt-studio:config:file-changed":{const{additions:u=[],deletions:S=[]}=A,g=u.find(k=>k.path===y.appConfig);g&&h(g==null?void 0:g.parsed),S.find(k=>k.path===y.appConfig)&&h(void 0);const x=u.find(k=>k.path===y.tokensConfig);x&&_(x==null?void 0:x.parsed),S.find(k=>k.path===y.tokensConfig)&&_(void 0);break}}}),s.hook("page:finish",()=>{p(),s.payload.prerenderedAt&&P()}),s.hook("content:document-driven:finish",({route:e,page:m})=>{e.meta.studio_page_contentId=m==null?void 0:m._id}),s.hook("nuxt-studio:preview:ready",()=>{window.parent.postMessage({type:"nuxt-studio:preview:ready",payload:r($())},"*"),setTimeout(()=>{p()},100)});function p(){const e=Array.from(window.document.querySelectorAll("[data-content-id]")).map(T=>T.getAttribute("data-content-id")),m=Array.from(new Set([n.meta.studio_page_contentId,...e])).filter(Boolean);if(i.value===m[0]){i.value="";return}window.openContentInStudioEditor(m,{navigate:!0,pageContentId:n.meta.studio_page_contentId})}window.openContentInStudioEditor=(e,m={})=>{window.parent.postMessage({type:"nuxt-studio:preview:navigate",payload:{...r(n),contentIds:e,...m}},"*")}}};export{de as useStudio};
